# 字幕融合API权限校验使用说明

## 概述

为了保护字幕融合API的安全性，现已为所有API接口添加了基于Token的权限校验机制。只有携带有效Token的请求才能访问API。

## 配置说明

### 1. 权限校验配置

在 `application.properties` 文件中配置：

```properties
# 是否启用权限校验（默认：true）
subtitlefusion.auth.enabled=true

# 有效的Token列表（用逗号分隔）
subtitlefusion.auth.tokens=sf_token_2024_admin,sf_token_2024_user1,sf_token_2024_user2,sf_token_2024_demo,sf_token_2024_test
```

### 2. 预设Token列表

当前系统预设了以下5个Token：

1. `sf_token_2024_admin` - 管理员Token
2. `sf_token_2024_user1` - 用户Token 1
3. `sf_token_2024_user2` - 用户Token 2
4. `sf_token_2024_demo` - 演示Token
5. `sf_token_2024_test` - 测试Token

## 使用方法

### 1. 请求头格式

在API请求中添加 `Authorization` 请求头，支持两种格式：

**格式1：直接Token**
```
Authorization: sf_token_2024_admin
```

**格式2：Bearer Token**
```
Authorization: Bearer sf_token_2024_admin
```

### 2. API请求示例

**正确的请求（会成功）：**
```http
POST http://localhost:8080/api/subtitles/burn-local-srt
Content-Type: application/json
Authorization: sf_token_2024_admin

{
  "videoPath": "C:\\path\\to\\video.mp4",
  "subtitlePath": "C:\\path\\to\\subtitle.srt"
}
```

**错误的请求（会返回401）：**
```http
POST http://localhost:8080/api/subtitles/burn-local-srt
Content-Type: application/json

{
  "videoPath": "C:\\path\\to\\video.mp4",
  "subtitlePath": "C:\\path\\to\\subtitle.srt"
}
```

### 3. 错误响应

当Token验证失败时，会返回401状态码和JSON格式的错误信息：

**缺少Authorization头：**
```json
{
  "code": 401,
  "message": "缺少Authorization头",
  "data": null
}
```

**无效的Token：**
```json
{
  "code": 401,
  "message": "无效的token",
  "data": null
}
```

## 安全建议

1. **Token保护**：请妥善保管Token，避免泄露
2. **定期更换**：建议定期更换Token以提高安全性
3. **环境隔离**：不同环境（开发/测试/生产）使用不同的Token
4. **访问控制**：根据需要为不同用户分配不同的Token

## 管理Token

### 添加新Token

在 `application.properties` 中的 `subtitlefusion.auth.tokens` 配置项中添加新Token：

```properties
subtitlefusion.auth.tokens=sf_token_2024_admin,sf_token_2024_user1,sf_token_2024_user2,sf_token_2024_demo,sf_token_2024_test,新的token
```

### 禁用权限校验

如果需要临时禁用权限校验（仅用于开发环境），可以设置：

```properties
subtitlefusion.auth.enabled=false
```

### 删除Token

从 `subtitlefusion.auth.tokens` 配置中移除对应的Token即可。

## 测试验证

使用提供的 `test_subtitle_with_java2d.http` 文件进行测试，该文件包含了各种权限校验场景的测试用例。

## 技术实现

- 使用Spring Boot的HandlerInterceptor实现请求拦截
- 对所有 `/api/**` 路径进行权限校验
- 支持配置化的Token管理
- 提供友好的错误响应格式
