# 字幕融合服务代码重构说明

## 重构概述

本次重构主要解决了以下问题：
1. **SubtitleFusionService 文件过大**（311行 -> 96行）
2. **添加URL支持**：支持从网络下载视频和字幕文件进行处理
3. **代码职责分离**：将单一大文件拆分为多个专门的服务类

## 新的服务架构

### 1. SubtitleFusionService（主服务）
- **文件位置**: `src/main/java/com/zhongjia/subtitlefusion/service/SubtitleFusionService.java`
- **职责**: 协调各个子服务完成字幕与视频的合成
- **主要方法**:
  - `burnSrtViaJava2D()` - 本地文件版本
  - `burnSrtViaJava2DFromUrls()` - URL版本（新增）

### 2. FileDownloadService（文件下载服务）
- **文件位置**: `src/main/java/com/zhongjia/subtitlefusion/service/FileDownloadService.java`
- **职责**: 从URL下载视频和字幕文件到本地临时目录
- **主要功能**:
  - 支持HTTP/HTTPS下载
  - 自动提取文件扩展名
  - 临时文件管理和清理
  - 30秒连接超时，60秒读取超时

### 3. SubtitleParserService（字幕解析服务）
- **文件位置**: `src/main/java/com/zhongjia/subtitlefusion/service/SubtitleParserService.java`
- **职责**: SRT字幕文件的解析、编码检测和转换
- **主要功能**:
  - SRT格式解析
  - 自动编码检测（UTF-8, GBK, GB2312, Big5等）
  - 编码转换
  - 乱码检测和处理

### 4. SubtitleRendererService（字幕渲染服务）
- **文件位置**: `src/main/java/com/zhongjia/subtitlefusion/service/SubtitleRendererService.java`
- **职责**: 将字幕绘制到视频帧上
- **主要功能**:
  - Java2D字幕渲染
  - 中文字体支持（Microsoft YaHei）
  - 阴影描边效果
  - 自适应字体大小

### 5. VideoProcessingService（视频处理服务）
- **文件位置**: `src/main/java/com/zhongjia/subtitlefusion/service/VideoProcessingService.java`
- **职责**: 视频帧的处理和字幕合成
- **主要功能**:
  - FFmpeg视频处理
  - 编码器配置优化
  - 时间戳处理
  - 输出文件管理

## 新增功能

### URL字幕合成接口

**接口地址**: `POST /api/subtitles/burn-url-srt`

**请求示例**:
```json
{
  "videoUrl": "https://example.com/video.mp4",
  "subtitleUrl": "https://example.com/subtitle.srt"
}
```

**功能特点**:
- 自动下载网络视频和字幕文件
- 支持各种常见的视频格式
- 自动清理临时文件
- 完整的错误处理

## 代码改进

### 1. 职责单一原则
- 每个服务类专注于单一职责
- 代码更易于维护和测试
- 便于后续功能扩展

### 2. 依赖注入
- 通过构造函数注入依赖
- 提高代码的可测试性
- 便于模拟和单元测试

### 3. 错误处理
- 完善的异常处理机制
- 临时文件自动清理
- 资源管理优化

### 4. 扩展性
- 易于添加新的字幕格式支持
- 易于添加新的下载方式
- 便于添加新的渲染效果

## 测试

### HTTP测试文件
- **文件位置**: `test_subtitle_with_java2d.http`
- **包含测试**:
  - 本地文件处理测试
  - URL文件处理测试
  - 权限校验测试
  - 各种token格式测试

### 测试用例
```http
### URL版本测试
POST http://localhost:8081/api/subtitles/burn-url-srt
Authorization: Bearer sf_token_2024_user1
Content-Type: application/json

{
  "videoUrl": "https://sample-videos.com/zip/10/mp4/SampleVideo_360x240_1mb.mp4",
  "subtitleUrl": "https://www.learningcontainer.com/wp-content/uploads/2020/02/Sample-SRT-File.srt"
}
```

## 性能优化

1. **下载优化**: 使用流式下载，避免大文件内存溢出
2. **编码检测**: 智能编码检测，提高字幕文件兼容性
3. **资源管理**: 自动清理临时文件，避免磁盘空间浪费
4. **错误恢复**: 完善的错误处理，提高系统稳定性

## 后续扩展建议

1. **支持更多字幕格式**: VTT, ASS等
2. **并发下载**: 支持视频和字幕文件并行下载
3. **缓存机制**: 对经常使用的文件进行缓存
4. **进度监控**: 添加处理进度查询接口
5. **批量处理**: 支持多个文件的批量处理
